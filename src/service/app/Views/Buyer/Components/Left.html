<!-- 구매자 메뉴-->
<?php
if($_SESSION['login_info']['type'] != 'buyer' || $_SESSION['login'] != 'success'){
echo "
<script>
  alert('로그인을 해주세요.');
  location.href = '/Auth/SignIn';
</script>
";
}
?>
<?php
$workers = $_SESSION['buyer_info']['workers']; // 상시 근로자 수
$severely_disabled = $_SESSION['buyer_info']['severely_disabled']; // 중증
$mild_disabled = $_SESSION['buyer_info']['mild_disabled'];  //경증
$tax_rate = $_SESSION['buyer_info']['tax_rate']; //법인세
if($tax_rate >0){
$cal_tax_rate = $tax_rate*0.01;
}
$classification = 0;
if($_SESSION['buyer_info']['classification'] == 1){ // 기업구분에 따른 의무고용율
$classification = 0.031;
}else{
$classification = 0.034;
}
$disabled = ($severely_disabled*2)+ $mild_disabled; // 장애인 근로자 계산
if($workers<50){
$employ = 0;
}else{
$employ =  floor($workers*$classification);
}
if($employ > 0){
$ratio = $disabled/$employ; //의무고용인원충족비율
}else{
$ratio = 0;
}
$base = 0;     //부담금기초
if($workers<100){
$base = 0;
}
if($ratio >= 0.75){
$base = 1149000;
}
else if($ratio >= 0.5){
$base = 1217940;
}
else if($ratio >= 0.25){
$base = 1378800;
}
else if($ratio > 0){
$base = 1608600;
}else{
$base = 1914440;
}
if($employ == $disabled){
$total_money = 0;
}else{
$employ = $employ-$disabled;
$total = $base * $employ*12 ; // 법인세 적용 전 납부급액
$total_money = $total + ($total*$cal_tax_rate); // 법인세 적용 후 납부금액
}
$buyer_reduction = $_SESSION['ReductionMoney']['buyer_reduction']; // 감면금액
if($buyer_reduction !="" && $total_money > 0){
$limit = ($buyer_reduction /$total)*100;
if($limit >= 60){
$buyer_reduction = ($total*0.6)+ ($total*0.6*$cal_tax_rate); // $cal_tax_rate = 법인세 *0.01
}else{
$buyer_reduction = $buyer_reduction+($buyer_reduction*$cal_tax_rate);
}
}
$Remainder_money = $total_money -$buyer_reduction; // 납부금액 - 감면금액
$max_reduction = $total*0.6*(1+$cal_tax_rate); // 감면금액의 60%
$limit_reduction = $max_reduction- $buyer_reduction;
if($total_money <= 0){
$Remainder_money = 0;
$buyer_reduction = 0;
$total_money = 0;
}
?>

<div class="left-fixed-box buyer-left-box py-4 px-3 text-white">
  <h2 class="mb-4"><span class="fw-bold">회사명</span>님의<br/>감면금액 계산기</h2>

  <div class="mb-3 pb-3 reduction-box">
    <h3 class="mb-1"><span>고용 부담금 납부금액</span></h3>
    <p class="sub-text mb-2">* 법인세 <span class="yellow-text"><?=$tax_rate?>%</span>적용</p>
    <p class="m-0 text-white fw-bold"><?=number_format($total_money)?>원</p>
  </div>
  <div class="mb-4 pb-3 reduction-box">
    <h3 class="mb-1"><span>기대 감면금액</span></h3>
    <p class="sub-text mb-2">* <span class="yellow-text"><?=number_format($max_reduction)?>원</span>까지 감면받을 수 있습니다.</p>
    <p class="m-0 text-white fw-bold"><?=number_format($buyer_reduction)?>원</p>
  </div>
  <div class="mb-4 border-bottom-0 reduction-box">
    <h3 class="mb-1"><span>감면 후 납부금액</span></h3>
    <?php
    if($limit_reduction <= 0){
    $limit_reduction = 0;
    }
    ?>
    <p class="sub-text mb-2">* <span class="yellow-text"><?=number_format($limit_reduction)?>원</span>까지 감면 받을 수 있습니다.</p>
    <?php
    if($max_reduction >= $Remainder_money){
    $Remainder_money = $max_reduction;
    }
    ?>
    <p class="m-0 text-white fw-bold"><?=number_format($Remainder_money)?>원</p>
  </div>

  <div class="mt-5">
    <h2 class="mb-3"><span class="fw-bold">회사명</span>님의<br/>진행 계약 현황 &#10095;</h2>
    <?php
    if(!$_SESSION["Contract"]) {
    ?>
    <div class="pt-2">
      <p class="text-white" style="font-size: 14px;">* 현재 진행중인 계약이 없습니다.</p>
    </div>

    <?php
    } else {
    ?>
    <ul class="buyer-contract-list p-0">
      <?php
    foreach($_SESSION["Contract"] as $item){
    $contract_regdt = $item["contract_regdt"];
    $timestamp = strtotime($contract_regdt);
    $contract_regdt = date("Y-m-d", $timestamp);
    $product_price = number_format($item["product_price"]);
    ?>
      <li class="mb-3 pb-3" onclick="contractView(<?=$item["workflow_id"]?>);">
        <h4 class="mb-2 text-start"><?=$item["product_name"]?></h4>
        <p class="m-0"><span>계약금액</span><?=$product_price?>원</p>
        <p class="m-0"><span>계약일자</span><?=$contract_regdt?></p>
        <p class="m-0"><span>수량</span><?=$item["product_quantity"]?></p>
      </li>
      <?php
    }
    ?>
    </ul>
    <?php
    }
    ?>
  </div>
</div>

<script>
  function contractView(workflow_id){
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon mgjv4YvW5hJwZet8rc43lk6PzONAcr7q//EZ3V8MkNs5U8dE8qw4amjpNMtaCupRi645Rz2K9/T4N1ylBhHzFI2tn0C/h7VLu5CHAa75N+GtMtKi1qAovYx7PKgNI1PokB4o1mlEK5s='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/' + workflow_id + '?offset=%2B09%3A00', options)
            .then(response => response.json())
            .then(response => /*console.log(response)*/{
              if(response['download_url'] == ""){
                window.open(response['playing_url']);
              }else{
                window.open(response['download_url']);
              }
            })
            .catch(err => console.error(err));
  }

</script>