<?php
  // Left Menu
  require APPPATH . '/Views/Buyer/Components/Left.html';
?>
<div class="flex-grow-1">
  <section class="buyer-contract">
    <div class="auto-container py-5">
      <?php
        // NAV
        require(__DIR__.'/Components/Nav.html');
      ?>
      <h3 class="mt-5 mb-4 h4 fw-bold text-center">계약현황</h3>

      <ul class="row border w-100 justify-content-around align-items-center mb-4 mx-auto py-4 text-center bg-light buyer-contract-summary">
        <li class="col-2 px-5 position-relative">
          <p class="h5">진행중</p>
          <p><strong class="h4 fw-bold"><?=$playing['playing']?></strong>건</p>
        </li>
        <li class="col-2 px-5 position-relative">
          <p class="h5">계약완료</p>
          <p><strong class="h4 fw-bold"><?=$complete['complete']?></strong>건</p>
        </li>
        <li class="col-4 px-5 position-relative">
          <p class="h5">계약금액</span></p>
          <p><strong class="h4 fw-bold"><?=number_format($price['price'])?></strong>원</p>
        </li>
        <li class="col-4 px-5">
          <p class="h5">감면금액</p>
          <p><strong class="h4 fw-bold"><?=number_format($reduction['reduction'])?></strong>원</p>
        </li>
      </ul>

        <form name="statusForm" id="statusForm" method="post" action="/Buyer/MyPage/ContractUpdate">
            <input type="hidden" name ="workflow_id" id="workflow_id" value="0">
            <input type="hidden" name ="pworkflow_id" id="pworkflow_id" value="0">
            <input type="hidden" name ="complete_reduction" id="complete_reduction" value="0">
            <input type="hidden" name ="product_quantity" id="product_quantity" value="">
            <input type="hidden" name ="uuid" id = "uuid" value="<?=$_SESSION['login_info']['uuid']?>">
        </form>

      <form name="myForm" method="GET" action="/Buyer/MyPage/Contract" >
          <input type="hidden" name="p_n" value="1">
          <table class="w-100 bg-light search-table" >
          <tbody>
          <tr>
            <th>상품명</th>
            <td>
              <input name="search_A"class="form-control me-3" type="text"
              <?php if($_GET["search_A"] != ""){ echo "value='".$_GET["search_A"]."'";}?>/>
            </td>
          </tr>
          <tr>
            <th>계약상태</th>
            <td>
              <label class="form-check-label" for="all">
                <input class="form-check-input" name="search_B" type="radio" value="all" id="all" <?php if($_GET["search_B"] == "all" || $_GET["search_B"] == ""){ echo "checked";}?>/> 전체
              </label>
              <label class="form-check-label" for="proceeding">
                <input class="form-check-input" name="search_B" type="radio" value="1" id="proceeding" <?php if($_GET["search_B"] == "1"){ echo "checked";}?>/> 승인대기
              </label>
              <label class="form-check-label" for="changed">
                <input class="form-check-input" name="search_B" type="radio" value="2" id="changed" <?php if($_GET["search_B"] == "2"){ echo "checked";}?>/> 진행중
              </label>
              <label class="form-check-label" for="completed">
                <input class="form-check-input" name="search_B" type="radio" value="5" id="completed" <?php if($_GET["search_B"] == "5"){ echo "checked";}?>/> 계약완료
              </label>
                <label class="form-check-label" for="cancel">
                    <input class="form-check-input" name="search_B" type="radio" value="9" id="cancel"/<?php if($_GET["search_B"] == "9"){ echo "checked";}?>> 계약취소
                </label>
            </td>
          </tr>
          <tr>
            <th>카테고리</th>
            <td>
              <select name ="search_C" class="form-select" aria-label="Default select example">
                <option value="all" <?php if($_GET["search_C"] == "all"){ echo "selected";}?>>전체</option>
                <option value="1" <?php if($_GET["search_C"] == "1"){ echo "selected";}?>>사무용품</option>
                <option value="2" <?php if($_GET["search_C"] == "2"){ echo "selected";}?>>생활용품</option>
                <option value="3" <?php if($_GET["search_C"] == "3"){ echo "selected";}?>>전산용품</option>
                <option value="4" <?php if($_GET["search_C"] == "4"){ echo "selected";}?>>식음료</option>
                <option value="5" <?php if($_GET["search_C"] == "5"){ echo "selected";}?>>청소용품</option>
              </select>
            </td>
          </tr>
          </tbody>
        </table>
        <div class="mt-3 text-center">
          <button class="btn btn-outline-secondary" type="reset">초기화</button>
          <button  class="btn btn-primary" type="submit">검색</button>
        </div>

          <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top border-2">
              <span>계약목록 (총 <strong><?=$data_page_total_cnt?></strong>개)</span>
              <div class="d-flex">
                  <button type="button" class="me-2 btn btn-sm btn-success flex-shrink-0 fw-normal" onclick="excelFileExport();">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                      </svg>
                      엑셀다운
                  </button>
                  <button type="button" class="btn btn-sm btn-warning flex-shrink-0 px-3" onclick="contract_update();">계약상태 최신화</button>
              </div>
          </div>
      <table class="table table-striped text-center mt-5 result-table" id ="BuyercontractTbl">
          <thead>
          <tr>
            <th>No.</th>
            <th>계약상태</th>
            <th>상품명</th>
            <th>상품수량</th>
            <th>계약금액</th>
            <th>감면금액</th>
            <th id ="test3333" >계약서조회</th>
            <th>계약서전송</th>
          </tr>
          </thead>
          <tbody>
          <?php
          if(is_array($data) && count($data) > 0){
          $i=1;
          if($_GET["p_n"]!=""){
          $i=($_GET["p_n"]-1)*10+1;
          }
          foreach($data as $item){
          $status = "";
          if($item["contract_status"] == 1){
          $status = "승인대기";
          }else if($item["contract_status"] == 2){
          $status = "진행중";
          }else if($item["contract_status"] == 3){
          $status = "구매기업 승인";
          }else if($item["contract_status"] ==5){
          $status = "계약완료";
          }else if($item["contract_status"] == 7){
          $status = "반려";
          }
          else if($item["contract_status"] == 9){
          $status = "계약취소";
          }

          $delivery_cycle = "";
          if($item["delivery_cycle"] == 1){
          $delivery_cycle = "1번";
          }else if($item["delivery_cycle"] == 2){
          $delivery_cycle = "1주일에 한 번";
          }else if($item["delivery_cycle"] == 3){
          $delivery_cycle = "1달에 한 번";
          }else if($item["delivery_cycle"] ==4){
          $delivery_cycle = "2달에 한 번";
          }else if($item["delivery_cycle"] == 5){
          $delivery_cycle = "6달에 한 번";
          }
          $category = "";
          if($item["product_category"] == 1){
          $category = "사무용품";
          }else if($item["product_category"] == 2){
          $category = "생활용품";
          }else if($item["product_category"] == 3){
          $category = "전산용품";
          }else if($item["product_category"] == 4){
          $category = "식음료";
          }else if($item["product_category"] == 5){
          $category = "청소용품";
          }
          ?>

          <tr>
            <td><?=$i?></td>
            <td title=<?=$status?>><?=$status?><?php if($item["workflow_id"] != "" && $item['contract_status'] != 5){?><span id="buyerTurn_<?=$item['workflow_id']?>" class="text-warning"></span><?php } ?></td>
            <td title=<?=$item["product_name"]?>><a href="/Buyer/Shop/Detail/<?=$item['product_no']?>?rm=<?=$item['reduction_money']?>"><?=$item["product_name"]?></a> </td>
            <td title=<?=$item["product_quantity"]?>><?=$item["product_quantity"]?></td>
            <td class="text-end" title=<?=$item["product_price"]?>><?=number_format($item["contract_price"])?>원</td>
            <td class="text-end" title="25,000,000"><?=number_format($item["reduction_money"])?>원</td>

            <?php
            if($item["contract_status"] == 2 || $item["contract_status"] == 5){
              ?>
            <td><button type="button" class="btn btn-primary btn-sm" onclick="Contract_Detail(<?=$item['workflow_id']?>)">계약서 조회</button></td>
            <td title="계약서 이메일로 받기"><button type="button" class ="btn btn-success btn-sm" onclick="Contract_Return(<?=$item['workflow_id']?>,<?=$item['contract_status']?>);">이메일로 받기</button></td>
            <?php
            } else {
            ?>
            <td></td>
            <td></td>
            <?php
            }
            ?>

          </tr>
          <?php
          $i++;
          }
          }
          ?>
          </tbody>
        </table>
        <?php if($data_page_total_cnt == 0){ echo"<div class='text-center'><span>계약목록이 없습니다</span>"; }?>

        <div class="float-start">
            <div class="dataTables_info" id="datatables_info" role="status" aria-live="polite"></div>
        </div>
        <ul style="float: right" class="pagination">
            <li class="paginate_button page-item previous disabled" id="datatables_previous">
                <?php
          if($data_page_total_cnt > 0){
                $page = $_GET["p_n"];
                $search_A = $_GET['search_A'];
                $search_B = $_GET['search_B'];
                $search_C = $_GET['search_C'];
                $page_per_record = 10;
                $block_ct = 5;
                $list = 10;
                $block_num = ceil($page/$block_ct); // 현재 페이지 블록 구하기
                $block_start = (($block_num - 1) * $block_ct) + 1; // 블록의 시작번호
                $block_end = $block_start + $block_ct - 1; //블록 마지막 번호
                $total_page = ceil($data_page_total_cnt / $list); // 페이징한 페이지 수 구하기
                if($block_end > $total_page){
                $block_end = $total_page;
                }
                $total_block = ceil($total_page/$block_ct);
                $start_num = ($page-1) * $list;
                if($_GET["p_n"]>1){?>
            <li class="paginate_button page-item"> <a href="javascript:nextPage(1,'<?=$search_A?>','<?=$search_B?>','<?=$search_C?>')" aria-controls="datatables" data-dt-idx="1" tabindex="0" class="page-link">처음으로</a></li>
            <?php }?>
            <?php
        if($page <= 1){
        ?>
            <?php
        }else{
        $pre = $page-1;
        ?>
            <li class="paginate_button page-item"> <a href="javascript:nextPage(<?=$pre?>,'<?=$search_A?>','<?=$search_B?>','<?=$search_C?>')" aria-controls="datatables" data-dt-idx="1" tabindex="0" class="page-link">이전</a></li>
        <?php
        }
        ?>
        <?php
         for($i= $block_start; $i<=$block_end;$i++){
              if($_GET["p_n"]==$i){?>
            <li class="paginate_button page-item active">
        <?php }else{ ?>
            <li class="paginate_button page-item">
        <?php } ?>
                <a href="javascript:nextPage(<?=$i?>,'<?=$search_A?>','<?=$search_B?>','<?=$search_C?>')" aria-controls="datatables" data-dt-idx="1" tabindex="0" class="page-link"><?=$i?></a>
            </li>
            <?php }?>
            <?php
        if($block_num >= $total_block){
            }else{
            $next_page = $page+1;
            ?>
            <li class="paginate_button page-item"> <a href="javascript:nextPage(<?=$next_page?>,'<?=$search_A?>','<?=$search_B?>','<?=$search_C?>')" aria-controls="datatables" data-dt-idx="1" tabindex="0" class="page-link">다음</a></li>
        <?php
        }
        ?>
        <?php
        if($_GET["p_n"]>=1 && $_GET["p_n"] != $total_page){?>
            <li class="paginate_button page-item"> <a href="javascript:nextPage(<?=$total_page?>,'<?=$search_A?>','<?=$search_B?>','<?=$search_C?>')" aria-controls="datatables" data-dt-idx="1" tabindex="0" class="page-link">마지막</a></li>
        <?php }}?>
        </ul>
      </form>
    </div>
  </section>
</div>
<script>

    function nextPage(p_n,a,b,c){
        location.href = '/Buyer/MyPage/Contract?p_n='+p_n+'&search_A='+a+'&search_B='+b+'&search_C='+c;
    }

    $(document).ready(function(){
        buyer_sequence();

    });

    function Buyer_turn(workflow_id){
        if(workflow_id != ""){
            $('#buyerTurn_'+workflow_id).text(' 내차례');
        }
    }

    function buyer_sequence(){
        var uuid = $("#uuid").val();
        const options = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: 'esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0='
            }
        };

        fetch('https://docs.esignon.net/api/v3/workflows/search-with-value?offset=%2B09%3A00&template_id=9&field_name=buyer_uuid&field_value='+uuid+'', options)
            .then(response => response.json())
            .then(response => {
                var j = 0;
                for(var i =0; i <response['workflow_list'].length; i++){
                    if(response['workflow_list'][i]['status'] == "Playing" && response['workflow_list'][i]['order'] == 1 || response['workflow_list'][i]['order'] == 3){
                        Buyer_turn(response['workflow_list'][i]['workflow_id']);
                        j++;
                    }
                }
            })
            .catch(err => console.error(err));
    }


  function Contract_reduction(workflow_id,pworkflow_id,cworkflow_id){
        if(workflow_id == ""){
            alert("최신상태 입니다.");
        }else {
            const options = {
                method: 'GET',
                headers: {
                    accept: 'application/json',
                    Authorization: 'esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0='
                }
            };
            var workflow_key = "";
            var contract_reduction = 0;
            var complete_reduction = 0;
            var workflow = [];
            var product_quantity = "";
            var workList = new Array();
            var x = 0;
            for (var i = 0; i < workflow_id.length; i++) {
                workflow_key = workflow_id[i];
                fetch('https://docs.esignon.net/api/v3/workflows/' + workflow_key + '?offset=%2B09%3A00', options)
                    .then(response => response.json())
                    .then(response => {
                        workflow[x] = new Array(3);
                        $.each(response['field_list'], function (idx, row) {
                            if (response['field_list'][idx].name == "Contract_Cost") {
                                contract_reduction = response['field_list'][idx].value;
                                complete_reduction = parseInt(contract_reduction.replace(/,/g, ""));
                                workflow[x][0] = complete_reduction;
                            }
                            if (response['field_list'][idx].name == "Contract_EA") {
                                product_quantity = response['field_list'][idx].value;
                                workflow[x][1] = product_quantity;
                            }
                        })
                        workflow[x][2] = response['workflow_id'];
                        var data = new Object();
                        data.complete_reduction = workflow[x][0];
                        data.product_quantity = workflow[x][1];
                        data.workflow_id = workflow[x][2];
                        data.pworkflow_id = pworkflow_id;
                        data.cworkflow_id = cworkflow_id;
                        workList.push(data);
                        if (x == workflow_id.length - 1) {
                            var jsonData = JSON.stringify(workList);
                            $.ajax({
                                method: 'post',
                                url: '/Buyer/MyPage/ContractUpdate',
                                data: jsonData,
                                contentType: "application/json",
                                success: function (result) {
                                    if (result != "") {
                                        alert("최신화 되었습니다.");
                                        location.reload();
                                    } else {
                                        alert("최신화 할 계약이 없습니다.");
                                    }
                                },
                                error: function () {
                                    alert("오류가 발생했습니다. 관리자에게 문의해주세요");
                                }
                            })
                        }
                        x++;
                    })
                    .catch(err => console.error(err));
            }
        }
  }


  function Contract_Detail(workflow_id){
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/' + workflow_id + '?offset=%2B09%3A00', options)
            .then(response => response.json())
            .then(response => {
              if(response['download_url'] == ""){
                window.open(response['playing_url']);
              }else{
                window.open(response['download_url']);
              }
            })
            .catch(err => console.error(err));
  }
function Contract_Return(workflow_id,status){
  if(status == 2){
    Contract_Playing(workflow_id);
    alert("이메일로 진행중인 계약서를 전송하였습니다.");
  }if(status == 5){
    Contract_Complate(workflow_id);
    alert("이메일로 완료된 계약서를 전송하였습니다.")
  }
}
  function Contract_Playing(workflow_id){
    const options = {
      method: 'POST',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/'+workflow_id+'/resend-playing', options)
            .then(response => response.json())
            .then(response => console.log(response))
            .catch(err => console.error(err));
  }

  function Contract_Complate(workflow_id){
    const sdk = require('api')('@esignon/v3.0#g604e4pl30t2t5s');
    sdk.auth('esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0=');
    sdk.resendCompleteWorkflow({workflowId:workflow_id})
            .then(res => console.log(res))
            .catch(err => console.error(err));
  }

function contract_update(){
  var uuid = $("#uuid").val();
  const options = {
    method: 'GET',
    headers: {
      accept: 'application/json',
      Authorization: 'esignon O2ebnbqCppPHLAvqjQEjZNY4mDt1cFGs5aqv8s9zDLaAAZGKfGcQ2NfStFDWPt/cInJNk4hUUArKkORv1PGgcHRmLr5HU7zBjl4PlUZKzUs3Vr0HG5tZN58CbBcLfrKBnOgp9rPJI/0='
    }
  };

  fetch('https://docs.esignon.net/api/v3/workflows/search-with-value?offset=%2B09%3A00&template_id=9&field_name=buyer_uuid&field_value='+uuid+'', options)
          .then(response => response.json())
          .then(response => {
            var workflow_id = [];
            var pworkflow_id = [];
            var cworkflow_id = [];
            var j = 0;
            var z = 0;
            var x = 0;
            for(var i =0; i <response['workflow_list'].length; i++){
              if(response['workflow_list'][i]['status'] == "Complete"){
                workflow_id[j] = response['workflow_list'][i]['workflow_id'];
                j++;
              }
                if(response['workflow_list'][i]['status'] == "Playing") {
                    pworkflow_id[x] = response['workflow_list'][i]['workflow_id'];
                    x++;
                }
                if(response['workflow_list'][i]['status'] == "Canceled"||response['workflow_list'][i]['status'] == "Disposal"||response['workflow_list'][i]['status'] == "Truncate") {
                    cworkflow_id[z] = response['workflow_list'][i]['workflow_id'];
                    z++;
                }
              }
           // alert(cworkflow_id);
           Contract_reduction(workflow_id,pworkflow_id,cworkflow_id);
          })
          .catch(err => console.error(err));
}


  function excelFileExport() {
      var table = document.getElementById('BuyercontractTbl');
      for(let j =1; j<=2; j++) {
          for (let i = 0; i < table.rows.length; i++) {
              table.rows[i].deleteCell(-1);
          }
      }
      var wb = XLSX.utils.table_to_book(document.getElementById('BuyercontractTbl'), {
          sheet: "sheet1",
          raw: true
      });
      let today = new Date();
      XLSX.writeFile(wb, ('계약리스트'+ today.getFullYear() + today.getMonth() + today.getDate()
          + today.getHours() + today.getMinutes() + today.getSeconds() +'.xlsx'));
        window.location.reload();
  }
</script>