<?php
  // Left Menu
  require APPPATH . '/Views/Buyer/Components/Left.html';
?>
<div class="flex-grow-1">
  <section class="buyer-contract">
    <div class="auto-container py-5">
      <?php
        // NAV
        require(__DIR__.'/Components/Nav.html');
      ?>
      <h3 class="mt-5 mb-4 h4 fw-bold text-center">계약현황</h3>
      <form name="myForm" method="GET" action="/Buyer/MyPage/Contract" >
        <table class="w-100 bg-light search-table">
          <tbody>
          <tr>
            <th>상품명</th>
            <td>
              <input name="search_A"class="form-control me-3" type="text"
              <?php if($_GET["search_A"] != ""){ echo "value='".$_GET["search_A"]."'";}?>/>
            </td>
          </tr>
          <tr>
            <th>계약상태</th>
            <td>
              <label class="form-check-label" for="all">
                <input class="form-check-input" name="search_B" type="radio" value="all" id="all" <?php if($_GET["search_B"] == "all" || $_GET["search_B"] == ""){ echo "checked";}?>/> 전체
              </label>
              <label class="form-check-label" for="proceeding">
                <input class="form-check-input" name="search_B" type="radio" value="1" id="proceeding" <?php if($_GET["search_B"] == "1"){ echo "checked";}?>/> 승인대기
              </label>
              <label class="form-check-label" for="changed">
                <input class="form-check-input" name="search_B" type="radio" value="2" id="changed" <?php if($_GET["search_B"] == "2"){ echo "checked";}?>/> 진행중
              </label>
              <label class="form-check-label" for="completed">
                <input class="form-check-input" name="search_B" type="radio" value="5" id="completed" <?php if($_GET["search_B"] == "5"){ echo "checked";}?>/> 계약완료
              </label>
            </td>
          </tr>
       <!--   <tr>
            <th>카테고리</th>
            <td>
              <select name ="search_C" class="form-select" aria-label="Default select example">
               <option selected>전체</option>
                <option value="1">사무용품</option>
                <option value="2">생활용품</option>
                <option value="3">전산용품</option>
                <option value="4">식음료</option>
                <option value="5">청소용품</option>
              </select>
            </td>
          </tr>-->
          </tbody>
        </table>
        <div class="mt-3 text-center">
          <button class="btn btn-primary" type="submit">검색</button>
          <button class="btn btn-outline-secondary" type="reset">초기화</button>
          <button class="btn btn-primary" onclick="contract_update()">계약상태 최신화</button>
        </div>
      </form>
      <table class="table table-striped text-center mt-5 result-table">
          <thead>
          <tr>
            <th>No.</th>
            <th>계약상태</th>
            <th>상품명</th>
            <th>상품수량</th>
            <th>계약금액</th>
            <th>감면금액</th>
            <th>계약서조회</th>
            <th>계약서전송</th>
          </tr>
          </thead>
          <tbody>
          <?php
          if(is_array($data) && count($data) > 0){
          foreach($data as $item){
          $status = "";
          if($item["contract_status"] == 1){
          $status = "승인대기";
          }else if($item["contract_status"] == 2){
          $status = "진행중";
          }else if($item["contract_status"] == 3){
          $status = "구매기업 승인";
          }else if($item["contract_status"] ==5){
          $status = "계약완료";
          }else if($item["contract_status"] == 7){
          $status = "반려";
          }
          else if($item["contract_status"] == 9){
          $status = "계약취소";
          }

          $delivery_cycle = "";
          if($item["delivery_cycle"] == 1){
          $delivery_cycle = "1번";
          }else if($item["delivery_cycle"] == 2){
          $delivery_cycle = "1주일에 한 번";
          }else if($item["delivery_cycle"] == 3){
          $delivery_cycle = "1달에 한 번";
          }else if($item["delivery_cycle"] ==4){
          $delivery_cycle = "2달에 한 번";
          }else if($item["delivery_cycle"] == 5){
          $delivery_cycle = "6달에 한 번";
          }
          $category = "";
          if($item["product_category"] == 1){
          $category = "사무용품";
          }else if($item["product_category"] == 2){
          $category = "생활용품";
          }else if($item["product_category"] == 3){
          $category = "전산용품";
          }else if($item["product_category"] == 4){
          $category = "식음료";
          }else if($item["product_category"] == 5){
          $category = "청소용품";
          }
          ?>

          <tr>
            <td><?=$item["cidx"]?></td>
            <td title=<?=$status?>><?=$status?></td>
            <td title=<?=$item["product_name"]?>><?=$item["product_name"]?></td>
            <td class="text-end" title=<?=$item["product_quantity"]?>><?=$item["product_quantity"]?></td>
            <td class="text-end" title=<?=$item["product_price"]?>><?=number_format($item["contract_price"])?>원</td>
            <td class="text-end" title="25,000,000"><?=number_format($item["reduction_money"])?>원</td>

            <?php
            if($item["contract_status"] == 2 || $item["contract_status"] == 5){
              ?>
            <td><button class="btn btn-primary btn-sm" onclick="Contract_Detail(<?=$item['workflow_id']?>)">계약서 조회</button></td>
            <td title="계약서 이메일로 받기"><button class ="btn btn-success btn-sm" onclick="Contract_Return(<?=$item['workflow_id']?>,<?=$item['contract_status']?>);">이메일로 받기</button></td>
            <?php
            }
            ?>

          </tr>
          <?php
          }
          }
          ?>
          </tbody>
        </table>
      </form>
    </div>
    <form name="statusForm" id="statusForm" method="post" action="/Buyer/MyPage/ContractUpdate">
      <input type="hidden" name ="workflow_id" id="workflow_id" value="0">
      <input type="hidden" name ="complete_reduction" id="complete_reduction" value="0">
      <input type="hidden" name ="uuid" id = "uuid" value="<?=$_SESSION['login_info']['uuid']?>">
    </form>
  </section>
</div>
<script>

  function Contract_reduction(workflow_id){
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
      }
    };
      var workflow_key = "";
      var contract_reduction = 0;
      var complete_reduction = 0;
      var workflow = "";
    for(var i = 0; i<workflow_id.length;i++) {
        workflow_key = workflow_id[i];
    fetch('https://docs.esignon.net/api/v3/workflows/' + workflow_key + '?offset=%2B09%3A00', options)
            .then(response => response.json())
            .then(response => {
              $.each(response['field_list'], function (idx, row) {
                if (response['field_list'][idx].name == "Contract_Cost") {
                    console.log(response);
                    contract_reduction = response['field_list'][idx].value;
                    complete_reduction = parseInt(contract_reduction.replace(/,/g,""));
                }
              })
                workflow = response['workflow_id'];
                $('#complete_reduction').val(complete_reduction);
                $('#workflow_id').val(workflow);
              //  $("#statusForm").submit();
               // alert(contract_reduction);
             //   alert(complete_reduction);
            })
            .catch(err => console.error(err));
    }
  }


  function Contract_Detail(workflow_id){
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/' + workflow_id + '?offset=%2B09%3A00', options)
            .then(response => response.json())
            .then(response => /*console.log(response)*/{
              if(response['download_url'] == ""){
                window.open(response['playing_url']);
              }else{
                window.open(response['download_url']);
              }
            })
            .catch(err => console.error(err));
  }
function Contract_Return(workflow_id,status){
  if(status == 2){
    Contract_Playing(workflow_id);
    alert("이메일로 진행중인 계약서를 전송하였습니다.");
  }if(status == 5){
    Contract_Complate(workflow_id);
    alert("이메일로 완료된 계약서를 전송하였습니다.")
  }
}
  function Contract_Playing(workflow_id){
    const options = {
      method: 'POST',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/'+workflow_id+'/resend-playing', options)
            .then(response => response.json())
            .then(response => console.log(response))
            .catch(err => console.error(err));
  }

  function Contract_Complate(workflow_id){
    const sdk = require('api')('@esignon/v3.0#g604e4pl30t2t5s');
    sdk.auth('esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE=');
    sdk.resendCompleteWorkflow({workflowId:workflow_id})
            .then(res => console.log(res))
            .catch(err => console.error(err));
  }

function contract_update(){
  var uuid = $("#uuid").val();
  const options = {
    method: 'GET',
    headers: {
      accept: 'application/json',
      Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
    }
  };

  fetch('https://docs.esignon.net/api/v3/workflows/search-with-value?offset=%2B09%3A00&template_id=9&field_name=buyer_uuid&field_value='+uuid+'', options)
          .then(response => response.json())
          .then(response => {
            var workflow_id = [];
            var j = 0;
            for(var i =0; i <response['workflow_list'].length; i++){
              if(response['workflow_list'][i]['status'] == "Complete"){
                workflow_id[j] = response['workflow_list'][i]['workflow_id'];
                //$('#workflow_id').val(workflow_id);
                j++;
              }
            }
              Contract_reduction(workflow_id);
          })
          .catch(err => console.error(err));
}
</script>