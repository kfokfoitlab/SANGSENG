<?php
  // Left Menu
  require(__DIR__.'/Components/Left.html');
?>
<div class="flex-grow-1">
  <section class="pt-5 layout-pb-120 contract-list">
    <div class="auto-container">
      <ul class="d-flex border w-100 justify-content-around align-items-center mb-4 py-4 text-center bg-light contract-list-number">
        <li class="px-5 position-relative">
          <p class="h5 text-primary">전체</p>
          <p class="text-primary"><strong class="h4 fw-bold"><?=$data_cnt['contract_cnt']?></strong>건</p>
        </li>
        <li class="px-5 position-relative">
          <p class="h5">승인대기</p>
          <p><strong class="h4 fw-bold"><?=$data_cnt['status1']?></strong>건</p>
        </li>
        <li class="px-5 position-relative">
          <p class="h5">진행중</span></p>
          <p><strong class="h4 fw-bold"><?=$data_cnt['status2']?></strong>건</p>
        </li>
        <li class="px-5">
          <p class="h5">계약완료</p>
          <p><strong class="h4 fw-bold"><?=$data_cnt['status5']?></strong>건</p>
        </li>
      </ul>

      <form name="myForm" method="post" action="/Seller/Contract" >
        <table class="contract-search-table w-100 bg-light border-top border-bottom">
          <tbody>
          <tr class="border-bottom">
            <th>검색어</th>
            <td>
              <div class="d-flex">
                <div class="d-flex align-items-center me-3">
                  <label class="form-label me-1 mb-0 col-form-label-sm flex-shrink-0" for="">계약번호</label>
                  <input name ="search_A" type="text" class="form-control form-control-sm"
                  <?php if($_GET["search_A"] != ""){ echo "value='".$_GET["search_A"]."'";}?>/>
                </div>
               <!-- <div class="d-flex align-items-center">
                  <label class="form-label me-1 mb-0 col-form-label-sm flex-shrink-0" for="">상품명</label>
                  <input type="text" class="form-control form-control-sm"/>
                </div>-->
              </div>
            </td>
          </tr>
          <tr class="border-bottom">
            <th>계약상태</th>
            <td>
              <label class="form-check-label me-3" for="flexCheck01">
                <input class="form-check-input" name="search_B" type="radio" value="all" id="flexCheck01" <?php if($_GET["search_B"] == "all" || $_GET["search_B"] == ""){ echo "checked";}?> /> 전체
              </label>
              <label class="form-check-label me-3" for="flexCheck02">
                <input class="form-check-input" name="search_B" type="radio" value="1" id="flexCheck02"/ <?php if($_GET["search_B"] == "1"){ echo "checked";}?>> 승인대기
              </label>
              <label class="form-check-label me-3" for="flexCheck03">
                <input class="form-check-input" name="search_B" type="radio" value="2" id="flexCheck03"/ <?php if($_GET["search_B"] == "2"){ echo "checked";}?>> 진행중
              </label>
              <label class="form-check-label" for="flexCheck04">
                <input class="form-check-input" name="search_B" type="radio" value="5" id="flexCheck04"/<?php if($_GET["search_B"] == "5"){ echo "checked";}?>> 계약완료
              </label>
            </td>
          </tr>
          </tbody>
        </table>
        <div class="text-center mt-4">
          <button class="btn btn-sm btn-outline-secondary me-3" type="reset">초기화</button>
          <button class="btn btn-sm btn-primary px-3" type="submit">검색</button>
          <button class="btn btn-sm btn-primary px-3" onclick="contract_update();">계약상태 최신화</button>

        </div>
      </form>
        <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top border-2">
          <span>계약목록 (총 <strong><?=count($data)?></strong>개)</span>


          <div class="d-flex">
<!--           <select class="form-select form-select-sm me-2" aria-label="Default select">
              <option value="all" selected>전체</option>
              <option value="recent">최근 계약일순</option>
              <option value="low">낮은 가격순</option>
              <option value="high">높은 가격순</option>
            </select>-->


            <select class="form-select form-select-sm me-2" aria-label="Default select">
              <option value="20" selected>20개씩</option>
              <option value="50">50개씩</option>
              <option value="100">100개씩</option>
              <option value="200">200개씩</option>
            </select>

            <button class="btn btn-sm btn-success flex-shrink-0 fw-normal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
              </svg>
              엑셀다운
            </button>
          </div>
        </div>

        <table class="contract-list-table table table-striped text-center mt-5">
          <thead>
          <tr>
            <th>No.</th>
            <th>계약상태</th>
            <th>계약번호</th>
            <th>상품명</th>
            <th>카테고리</th>
            <th>물품수량</th>
            <th>계약금액</th>
            <th>감면금액</th>
            <th>계약등록일</th>
            <th>배송주기</th>
            <th>구매기업</th>
            <th>계약서 전송받기</th>
          </tr>
          </thead>
          <tbody>
          <?php
          if(is_array($data) && count($data) > 0){
          foreach($data as $item){
          $status = "";
          if($item["contract_status"] == 1){
          $status = "승인대기";
          }else if($item["contract_status"] == 2){
          $status = "진행중";
          }else if($item["contract_status"] == 3){
          $status = "구매기업 승인";
          }else if($item["contract_status"] ==5){
          $status = "계약완료";
          }else if($item["contract_status"] == 7){
          $status = "반려";
          }
          else if($item["contract_status"] == 9){
          $status = "계약취소";
          }

          $delivery_cycle = "";
          if($item["delivery_cycle"] == 1){
          $delivery_cycle = "1번";
          }else if($item["delivery_cycle"] == 2){
          $delivery_cycle = "1주일에 한 번";
          }else if($item["delivery_cycle"] == 3){
          $delivery_cycle = "1달에 한 번";
          }else if($item["delivery_cycle"] ==4){
          $delivery_cycle = "2달에 한 번";
          }else if($item["delivery_cycle"] == 5){
          $delivery_cycle = "6달에 한 번";
          }
          $category = "";
          if($item["product_category"] == 1){
          $category = "사무용품";
          }else if($item["product_category"] == 2){
          $category = "생활용품";
          }else if($item["product_category"] == 3){
          $category = "전산용품";
          }else if($item["product_category"] == 4){
          $category = "식음료";
          }else if($item["product_category"] == 5){
          $category = "청소용품";
          }
          $product_price = number_format($item["product_price"]);
          ?>
          <tr>
            <td><?=$item["cidx"]?></td>
            <td title="진행중"><?=$status?></td>
            <td title="20220801090000-00001"><a href=""><?=$item["contract_no"]?></a></td>
            <td title="친환경중질지70gA4용지"><?=$item["product_name"]?></td>
            <td title="사무용품"><?=$category?></td>
            <td title="100BOX"><?=$item["product_quantity"]?></td>
            <td title="250,000,000"><?=$product_price?>원</td>
            <td title="25,000,000">25,000,000</td>
            <td title="2022-08-01"><?=$item["register_date"]?></td>
            <td title="일주일에 한번"><?=$delivery_cycle?></td>
            <td title="22-08-02"><?=$item["buyer_company"]?></td>
            <td title="20220801090000-00001">
              <?php
            if($item["contract_status"] == 2 || $item["contract_status"] == 5){
              ?>
              <button class ="btn btn-success" onclick="Contract_Return(<?=$item['workflow_id']?>,<?=$item['contract_status']?>);">이메일로 받기</button>
              <?php
            }
            ?>
            </td>
          </tr>
          <?php
          }
          }
          ?>
          </tbody>
        </table>
      </form>
    </div>
    <form name="statusForm" id="statusForm" method="post" action="/Seller/ContractUpdate">
      <input type="hidden" name ="workflow_id" id="workflow_id" value="">
      <input type="hidden" name ="uuid" id = "uuid" value="<?=$_SESSION['login_info']['uuid']?>">
    </form>
  </section>
</div>
<script>
  function Contract_Return(workflow_id,status){
    if(status == 2){
      Contract_Playing(workflow_id);
      alert("이메일로 진행중인 계약서를 전송하였습니다.");
    }if(status == 5){
      Contract_Complate(workflow_id);
      alert("이메일로 완료된 계약서를 전송하였습니다.")
    }
  }
  function Contract_Playing(workflow_id){
    const options = {
      method: 'POST',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
      }
    };
    fetch('https://docs.esignon.net/api/v3/workflows/'+workflow_id+'/resend-playing', options)
            .then(response => response.json())
            .then(response => console.log(response))
            .catch(err => console.error(err));
  }

  function Contract_Complate(workflow_id){
    const sdk = require('api')('@esignon/v3.0#g604e4pl30t2t5s');
    sdk.auth('esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE=');
    sdk.resendCompleteWorkflow({workflowId:workflow_id})
            .then(res => console.log(res))
            .catch(err => console.error(err));
  }

  function contract_update(){
    var uuid = $("#uuid").val();
    const options = {
      method: 'GET',
      headers: {
        accept: 'application/json',
        Authorization: 'esignon jlxfF8HAeRw1/8iUN5OVSH+060OTnZ+j7vRJdTHLFVSMzuM3n4MCaavEg6S0rFMpVNTkFsgGBWJ2usJ1j9T8uni3QARD+1L1cLc7W+PJ/M9dMoyAruRZ1C3NQusJ88gQ0utugU+hNRE='
      }
    };

    fetch('https://docs.esignon.net/api/v3/workflows/search-with-value?offset=%2B09%3A00&template_id=6&field_name=buyer_uuid&field_value='+uuid+'', options)
            .then(response => response.json())
            .then(response => {
              var workflow_id = [];
              var j = 0;
              for(var i =0; i <response['workflow_list'].length; i++){
                if(response['workflow_list'][i]['status'] == "Complete"){
                  workflow_id[j] = response['workflow_list'][i]['workflow_id'];
                  $('#workflow_id').val(workflow_id);
                  j++;
                }
              }
              $("#statusForm").submit();
            })
            .catch(err => console.error(err));
  }
</script>